import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Cookie } from 'ng2-cookies';
var LogglyService = /** @class */ (function () {
    function LogglyService(_http) {
        this._http = _http;
        this.LOGGLY_INPUT_PREFIX = 'https://';
        this.LOGGLY_COLLECTOR_DOMAIN = 'logs-01.loggly.com';
        this.LOGGLY_SESSION_KEY = 'logglytrackingsession';
        this.LOGGLY_SESSION_KEY_LENGTH = this.LOGGLY_SESSION_KEY + 1;
        this.LOGGLY_PROXY_DOMAIN = 'loggly';
    }
    LogglyService.prototype.setProtocol = function (protocol) {
        this.LOGGLY_INPUT_PREFIX = protocol;
    };
    LogglyService.prototype.uuid = function () {
        // lifted from here -> http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/2117523#2117523
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    };
    LogglyService.prototype.setKey = function (tracker, key) {
        tracker.key = key;
        tracker.setSession();
        this.setInputUrl(tracker);
    };
    LogglyService.prototype.setTag = function (tracker, tag) {
        tracker.tag = tag;
    };
    LogglyService.prototype.setDomainProxy = function (tracker, useDomainProxy) {
        tracker.useDomainProxy = useDomainProxy;
        // refresh inputUrl value
        this.setInputUrl(tracker);
    };
    LogglyService.prototype.setSendConsoleError = function (tracker, sendConsoleErrors) {
        tracker.sendConsoleErrors = sendConsoleErrors;
        if (tracker.sendConsoleErrors === true) {
            var _onerror_1 = window.onerror;
            // send console error messages to Loggly
            window.onerror = function (msg, url, line, col) {
                tracker.push({
                    category: 'BrowserJsException',
                    exception: {
                        message: msg,
                        url: url,
                        lineno: line,
                        colno: col,
                    }
                });
                if (_onerror_1 && typeof _onerror_1 === 'function') {
                    _onerror_1.apply(window, arguments);
                }
            };
        }
    };
    LogglyService.prototype.setInputUrl = function (tracker) {
        if (tracker.useDomainProxy === true) {
            tracker.inputUrl = this.LOGGLY_INPUT_PREFIX
                + window.location.host
                + '/'
                + this.LOGGLY_PROXY_DOMAIN
                + '/inputs/'
                + tracker.key
                + '/tag/'
                + tracker.tag;
        }
        else {
            tracker.inputUrl = this.LOGGLY_INPUT_PREFIX
                + (tracker.logglyCollectorDomain || this.LOGGLY_COLLECTOR_DOMAIN)
                + '/inputs/'
                + tracker.key
                + '/tag/'
                + tracker.tag;
        }
    };
    LogglyService.prototype.setSession = function (session_id) {
        if (session_id) {
            this.session_id = session_id;
            this.setCookie(this.session_id);
        }
        else if (!this.session_id) {
            this.session_id = this.readCookie();
            if (!this.session_id) {
                this.session_id = this.uuid();
                this.setCookie(this.session_id);
            }
        }
    };
    LogglyService.prototype.push = function (data) {
        var type = typeof data;
        if (!data || !(type === 'object' || type === 'string')) {
            return;
        }
        var self = this;
        if (type === 'string') {
            data = {
                'text': data
            };
        }
        else {
            if (data.logglyCollectorDomain) {
                self.logglyCollectorDomain = data.logglyCollectorDomain;
                return;
            }
            if (data.sendConsoleErrors !== undefined) {
                this.setSendConsoleError(self, data.sendConsoleErrors);
            }
            if (data.tag) {
                this.setTag(self, data.tag);
            }
            if (data.useDomainProxy) {
                this.setDomainProxy(self, data.useDomainProxy);
            }
            if (data.logglyKey) {
                this.setKey(self, data.logglyKey);
                return;
            }
            if (data.session_id) {
                self.setSession(data.session_id);
                return;
            }
        }
        if (!self.key) {
            return;
        }
        self.track(data).subscribe(function (response) {
            // Success
        }, function (error) {
            console.error(error);
        });
    };
    LogglyService.prototype.track = function (data) {
        // inject session id
        data.sessionId = this.session_id;
        return this._http.post(this.inputUrl, data, { headers: new HttpHeaders().set('Content-Type', 'text/plain') });
    };
    LogglyService.prototype.readCookie = function () {
        var cookie = Cookie.get(this.LOGGLY_SESSION_KEY);
        if (cookie) {
            var i = cookie.indexOf(this.LOGGLY_SESSION_KEY);
            if (i < 0) {
                return false;
            }
            else {
                var end = cookie.indexOf(';', i + 1);
                end = end < 0 ? cookie.length : end;
                return cookie.slice(i + this.LOGGLY_SESSION_KEY_LENGTH, end);
            }
        }
        else {
            return false;
        }
    };
    LogglyService.prototype.setCookie = function (value) {
        Cookie.set(this.LOGGLY_SESSION_KEY, value);
    };
    LogglyService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [HttpClient])
    ], LogglyService);
    return LogglyService;
}());
export { LogglyService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2x5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtbG9nZ2x5LWxvZ2dlci8iLCJzb3VyY2VzIjpbImxvZ2dseS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUdyQztJQVNJLHVCQUFvQixLQUFpQjtRQUFqQixVQUFLLEdBQUwsS0FBSyxDQUFZO1FBQ2pDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLENBQUM7UUFDdEMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLG9CQUFvQixDQUFDO1FBQ3BELElBQUksQ0FBQyxrQkFBa0IsR0FBRyx1QkFBdUIsQ0FBQztRQUNsRCxJQUFJLENBQUMseUJBQXlCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxtQ0FBVyxHQUFYLFVBQVksUUFBUTtRQUNoQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDO0lBQ3hDLENBQUM7SUFFRCw0QkFBSSxHQUFKO1FBQ0ksd0hBQXdIO1FBQ3hILE9BQU8sc0NBQXNDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUM7WUFDdEUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3BFLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxF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RyxJQUFJLENBQUMseUJBQXlCLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDaEU7U0FDSjthQUFNO1lBQ0gsT0FBTyxLQUFLLENBQUM7U0FDaEI7SUFDTCxDQUFDO0lBRUQsaUNBQVMsR0FBVCxVQUFVLEtBQVU7UUFDaEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQXRMUSxhQUFhO1FBRHpCLFVBQVUsRUFBRTtpREFVa0IsVUFBVTtPQVQ1QixhQUFhLENBdUx6QjtJQUFELG9CQUFDO0NBQUEsQUF2TEQsSUF1TEM7U0F2TFksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgQ29va2llIH0gZnJvbSAnbmcyLWNvb2tpZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTG9nZ2x5U2VydmljZSB7XG4gICAgcHJpdmF0ZSBMT0dHTFlfSU5QVVRfUFJFRklYOiBhbnk7XG4gICAgcHJpdmF0ZSBMT0dHTFlfQ09MTEVDVE9SX0RPTUFJTjogYW55O1xuICAgIHByaXZhdGUgTE9HR0xZX1NFU1NJT05fS0VZOiBhbnk7XG4gICAgcHJpdmF0ZSBMT0dHTFlfU0VTU0lPTl9LRVlfTEVOR1RIOiBhbnk7XG4gICAgcHJpdmF0ZSBMT0dHTFlfUFJPWFlfRE9NQUlOOiBhbnk7XG4gICAgcHJpdmF0ZSBzZXNzaW9uX2lkOiBhbnk7XG4gICAgcHJpdmF0ZSBpbnB1dFVybDogYW55O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaHR0cDogSHR0cENsaWVudCkge1xuICAgICAgICB0aGlzLkxPR0dMWV9JTlBVVF9QUkVGSVggPSAnaHR0cHM6Ly8nO1xuICAgICAgICB0aGlzLkxPR0dMWV9DT0xMRUNUT1JfRE9NQUlOID0gJ2xvZ3MtMDEubG9nZ2x5LmNvbSc7XG4gICAgICAgIHRoaXMuTE9HR0xZX1NFU1NJT05fS0VZID0gJ2xvZ2dseXRyYWNraW5nc2Vzc2lvbic7XG4gICAgICAgIHRoaXMuTE9HR0xZX1NFU1NJT05fS0VZX0xFTkdUSCA9IHRoaXMuTE9HR0xZX1NFU1NJT05fS0VZICsgMTtcbiAgICAgICAgdGhpcy5MT0dHTFlfUFJPWFlfRE9NQUlOID0gJ2xvZ2dseSc7XG4gICAgfVxuXG4gICAgc2V0UHJvdG9jb2wocHJvdG9jb2wpIHtcbiAgICAgICAgdGhpcy5MT0dHTFlfSU5QVVRfUFJFRklYID0gcHJvdG9jb2w7XG4gICAgfVxuXG4gICAgdXVpZCgpIHtcbiAgICAgICAgLy8gbGlmdGVkIGZyb20gaGVyZSAtPiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEwNTAzNC9ob3ctdG8tY3JlYXRlLWEtZ3VpZC11dWlkLWluLWphdmFzY3JpcHQvMjExNzUyMyMyMTE3NTIzXG4gICAgICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7XG4gICAgICAgICAgICBsZXQgciA9IE1hdGgucmFuZG9tKCkgKiAxNiB8IDAsIHYgPSBjID09PSAneCcgPyByIDogKHIgJiAweDMgfCAweDgpO1xuICAgICAgICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzZXRLZXkodHJhY2tlcjogYW55LCBrZXk6IGFueSkge1xuICAgICAgICB0cmFja2VyLmtleSA9IGtleTtcbiAgICAgICAgdHJhY2tlci5zZXRTZXNzaW9uKCk7XG4gICAgICAgIHRoaXMuc2V0SW5wdXRVcmwodHJhY2tlcik7XG4gICAgfVxuXG4gICAgc2V0VGFnKHRyYWNrZXI6IGFueSwgdGFnOiBhbnkpIHtcbiAgICAgICAgdHJhY2tlci50YWcgPSB0YWc7XG4gICAgfVxuXG4gICAgc2V0RG9tYWluUHJveHkodHJhY2tlcjogYW55LCB1c2VEb21haW5Qcm94eTogYW55KSB7XG4gICAgICAgIHRyYWNrZXIudXNlRG9tYWluUHJveHkgPSB1c2VEb21haW5Qcm94eTtcbiAgICAgICAgLy8gcmVmcmVzaCBpbnB1dFVybCB2YWx1ZVxuICAgICAgICB0aGlzLnNldElucHV0VXJsKHRyYWNrZXIpO1xuICAgIH1cblxuICAgIHNldFNlbmRDb25zb2xlRXJyb3IodHJhY2tlcjogYW55LCBzZW5kQ29uc29sZUVycm9yczogYW55KSB7XG4gICAgICAgIHRyYWNrZXIuc2VuZENvbnNvbGVFcnJvcnMgPSBzZW5kQ29uc29sZUVycm9ycztcblxuICAgICAgICBpZiAodHJhY2tlci5zZW5kQ29uc29sZUVycm9ycyA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgbGV0IF9vbmVycm9yID0gd2luZG93Lm9uZXJyb3I7XG4gICAgICAgICAgICAvLyBzZW5kIGNvbnNvbGUgZXJyb3IgbWVzc2FnZXMgdG8gTG9nZ2x5XG4gICAgICAgICAgICB3aW5kb3cub25lcnJvciA9IGZ1bmN0aW9uIChtc2csIHVybCwgbGluZSwgY29sKSB7XG4gICAgICAgICAgICAgICAgdHJhY2tlci5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6ICdCcm93c2VySnNFeGNlcHRpb24nLFxuICAgICAgICAgICAgICAgICAgICBleGNlcHRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZW5vOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sbm86IGNvbCxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKF9vbmVycm9yICYmIHR5cGVvZiBfb25lcnJvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBfb25lcnJvci5hcHBseSh3aW5kb3csIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldElucHV0VXJsKHRyYWNrZXI6IGFueSkge1xuICAgICAgICBpZiAodHJhY2tlci51c2VEb21haW5Qcm94eSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgdHJhY2tlci5pbnB1dFVybCA9IHRoaXMuTE9HR0xZX0lOUFVUX1BSRUZJWFxuICAgICAgICAgICAgICAgICsgd2luZG93LmxvY2F0aW9uLmhvc3RcbiAgICAgICAgICAgICAgICArICcvJ1xuICAgICAgICAgICAgICAgICsgdGhpcy5MT0dHTFlfUFJPWFlfRE9NQUlOXG4gICAgICAgICAgICAgICAgKyAnL2lucHV0cy8nXG4gICAgICAgICAgICAgICAgKyB0cmFja2VyLmtleVxuICAgICAgICAgICAgICAgICsgJy90YWcvJ1xuICAgICAgICAgICAgICAgICsgdHJhY2tlci50YWc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cmFja2VyLmlucHV0VXJsID0gdGhpcy5MT0dHTFlfSU5QVVRfUFJFRklYXG4gICAgICAgICAgICAgICAgKyAodHJhY2tlci5sb2dnbHlDb2xsZWN0b3JEb21haW4gfHwgdGhpcy5MT0dHTFlfQ09MTEVDVE9SX0RPTUFJTilcbiAgICAgICAgICAgICAgICArICcvaW5wdXRzLydcbiAgICAgICAgICAgICAgICArIHRyYWNrZXIua2V5XG4gICAgICAgICAgICAgICAgKyAnL3RhZy8nXG4gICAgICAgICAgICAgICAgKyB0cmFja2VyLnRhZztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldFNlc3Npb24oc2Vzc2lvbl9pZDogYW55KSB7XG4gICAgICAgIGlmIChzZXNzaW9uX2lkKSB7XG4gICAgICAgICAgICB0aGlzLnNlc3Npb25faWQgPSBzZXNzaW9uX2lkO1xuICAgICAgICAgICAgdGhpcy5zZXRDb29raWUodGhpcy5zZXNzaW9uX2lkKTtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5zZXNzaW9uX2lkKSB7XG4gICAgICAgICAgICB0aGlzLnNlc3Npb25faWQgPSB0aGlzLnJlYWRDb29raWUoKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5zZXNzaW9uX2lkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXNzaW9uX2lkID0gdGhpcy51dWlkKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRDb29raWUodGhpcy5zZXNzaW9uX2lkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1c2goZGF0YTogYW55KSB7XG4gICAgICAgIGxldCB0eXBlID0gdHlwZW9mIGRhdGE7XG5cbiAgICAgICAgaWYgKCFkYXRhIHx8ICEodHlwZSA9PT0gJ29iamVjdCcgfHwgdHlwZSA9PT0gJ3N0cmluZycpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc2VsZjogYW55ID0gdGhpcztcblxuXG4gICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAndGV4dCc6IGRhdGFcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZGF0YS5sb2dnbHlDb2xsZWN0b3JEb21haW4pIHtcbiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dseUNvbGxlY3RvckRvbWFpbiA9IGRhdGEubG9nZ2x5Q29sbGVjdG9yRG9tYWluO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRhdGEuc2VuZENvbnNvbGVFcnJvcnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U2VuZENvbnNvbGVFcnJvcihzZWxmLCBkYXRhLnNlbmRDb25zb2xlRXJyb3JzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRhdGEudGFnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRUYWcoc2VsZiwgZGF0YS50YWcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZGF0YS51c2VEb21haW5Qcm94eSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0RG9tYWluUHJveHkoc2VsZiwgZGF0YS51c2VEb21haW5Qcm94eSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkYXRhLmxvZ2dseUtleSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0S2V5KHNlbGYsIGRhdGEubG9nZ2x5S2V5KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkYXRhLnNlc3Npb25faWQpIHtcbiAgICAgICAgICAgICAgICBzZWxmLnNldFNlc3Npb24oZGF0YS5zZXNzaW9uX2lkKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXNlbGYua2V5KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzZWxmLnRyYWNrKGRhdGEpLnN1YnNjcmliZShcbiAgICAgICAgICAgIChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gU3VjY2Vzc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB0cmFjayhkYXRhOiBhbnkpIHtcbiAgICAgICAgLy8gaW5qZWN0IHNlc3Npb24gaWRcbiAgICAgICAgZGF0YS5zZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25faWQ7XG4gICAgICAgIHJldHVybiB0aGlzLl9odHRwLnBvc3Q8YW55Pih0aGlzLmlucHV0VXJsLCBkYXRhLCB7aGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKCkuc2V0KCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbicpfSk7XG4gICAgfVxuXG4gICAgcmVhZENvb2tpZSgpOiBhbnkge1xuICAgICAgICBsZXQgY29va2llID0gQ29va2llLmdldCh0aGlzLkxPR0dMWV9TRVNTSU9OX0tFWSk7XG4gICAgICAgIGlmIChjb29raWUpIHtcbiAgICAgICAgICAgIGxldCBpID0gY29va2llLmluZGV4T2YodGhpcy5MT0dHTFlfU0VTU0lPTl9LRVkpO1xuICAgICAgICAgICAgaWYgKGkgPCAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgZW5kID0gY29va2llLmluZGV4T2YoJzsnLCBpICsgMSk7XG4gICAgICAgICAgICAgICAgZW5kID0gZW5kIDwgMCA/IGNvb2tpZS5sZW5ndGggOiBlbmQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvb2tpZS5zbGljZShpICsgdGhpcy5MT0dHTFlfU0VTU0lPTl9LRVlfTEVOR1RILCBlbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2V0Q29va2llKHZhbHVlOiBhbnkpIHtcbiAgICAgICAgQ29va2llLnNldCh0aGlzLkxPR0dMWV9TRVNTSU9OX0tFWSwgdmFsdWUpO1xuICAgIH1cbn1cbiJdfQ==